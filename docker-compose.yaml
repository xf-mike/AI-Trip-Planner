version: '3.4'

services:
  # ======================================
  # 1. åç«¯æœåŠ¡ (Backend Service)
  # ======================================
  backend:
    # ä½¿ç”¨æ‚¨çš„é•œåƒæ ‡ç­¾ï¼Œä¸æ‚¨çš„ docker build å‘½ä»¤ä¿æŒä¸€è‡´
    image: xf2000/trip-planner-app:v3
    
    # # ä½¿ç”¨ build å—å¯ä»¥è®©æ‚¨åœ¨æ²¡æœ‰é•œåƒæ—¶ï¼Œç›´æ¥è¿è¡Œ 'docker compose up --build' æ¥æ„å»º
    # build:
    #   context: .
    #   dockerfile: Dockerfile
      
    # ğŸš¨ ä»…æš´éœ²åç«¯ç«¯å£åˆ°ä¸»æœº
    ports:
      - "8080:8080" 
      
    # ä» .env æ–‡ä»¶ä¸­å¯¼å…¥å˜é‡
    environment:
      IS_DOCKER_COMPOSE: True
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
      GOOGLE_CSE_ID: ${GOOGLE_CSE_ID}
      USE_LTM: True
      USE_VEC_DB: True
      VERBOSE: True
      RUN_AS_DEV: False
      
    depends_on:
      - weaviate 
      
    # åŠ å…¥ç§æœ‰ç½‘ç»œ
    networks:
      - app-network 

  # ======================================
  # 2. Weaviate æœåŠ¡ (Vector DB)
  # ======================================
  weaviate:
    image: cr.weaviate.io/semitechnologies/weaviate:1.27.0
    
    # ğŸš¨ ç§»é™¤ ports æ˜ å°„ï¼Œå®ç°ç½‘ç»œéš”ç¦»ï¼ˆåªèƒ½é€šè¿‡ backend è®¿é—®ï¼‰
    # ports:
    #   - "5432:8080"
    #   - "50051:50051"
    
    volumes:
      - ./weaviate_data:/var/lib/weaviate
    environment:
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'
      DEFAULT_VECTORIZER_MODULE: 'text2vec-openai'
      ENABLE_MODULES: 'text2vec-openai,generative-openai'
      CLUSTER_HOSTNAME: 'weaviate'
      # Weaviate ä¹Ÿéœ€è¦è®¿é—® OpenAI Key
      OPENAI_APIKEY: ${OPENAI_API_KEY}
      
    # åŠ å…¥ç§æœ‰ç½‘ç»œ
    networks:
      - app-network 

# ======================================
# 3. ç½‘ç»œå®šä¹‰
# ======================================
networks:
  app-network:
    driver: bridge